# 開発更新ログ - 2026年2月14日

## 概要

Jumbory備品管理システムの大規模な機能拡張とインフラ整備を実施しました。基本的な備品管理機能から、スカウト・指導者管理、データベースのクラウド化、Docker対応まで、実用レベルのシステムに進化しました。

---

## 実装した機能

### 1. スカウト管理機能

**実装内容：**
- スカウト情報の登録・編集・一覧表示
- CSV一括アップロード機能
- パスワード認証機能（パスワード: `19nsj@saitama7tai`）
- 学年選択（中1〜中3）
- 班名のインライン編集

**データモデル：**
```python
class Scout(Base):
    id: Integer (Primary Key)
    name: String (名前)
    name_kana: String (ふりがな)
    group_id: Integer (所属団 Foreign Key)
    grade: String (学年: 中1/中2/中3)
    rank: String (級)
    gender: String (性別: 男/女)
    patrol: String (班名)
```

**エンドポイント：**
- `GET /api/scouts` - スカウト一覧取得
- `POST /api/scouts` - スカウト登録
- `PUT /api/scouts/{id}` - スカウト更新（部分更新対応）
- `POST /api/scouts/upload-csv` - CSV一括登録

**フロントエンド：**
- `/scouts` - スカウト管理ページ（パスワード保護）
- セッションストレージによる認証状態管理
- インライン編集UI（班名フィールド）

---

### 2. 指導者管理機能

**実装内容：**
- 指導者情報の登録・編集・一覧表示
- 役職のインライン編集
- プライバシー保護（電話、メール、性別は非表示）

**データモデル：**
```python
class Leader(Base):
    id: Integer (Primary Key)
    name: String (名前)
    group_id: Integer (所属団 Foreign Key)
    role: String (役職)
    gender: String (性別 - バックエンドのみ)
    phone: String (電話番号 - バックエンドのみ)
    email: String (メールアドレス - バックエンドのみ)
```

**エンドポイント：**
- `GET /api/leaders` - 指導者一覧取得
- `POST /api/leaders` - 指導者登録
- `PUT /api/leaders/{id}` - 指導者更新（部分更新対応）

**フロントエンド：**
- `/leaders` - 指導者管理ページ
- 個人情報（電話、メール、性別）は公開画面に表示しない
- インライン編集UI（役職フィールド）

---

### 3. 団体（グループ）管理

**実装内容：**
- 9つの実在団体データを登録
- 備品、スカウト、指導者との外部キー関連付け

**登録団体：**
1. 春日部第９団
2. 春日部第７団
3. 久喜第１団
4. 久喜第２１団
5. 蓮田第１団
6. 蓮田第３団
7. 加須第１団
8. 宮代第１団
9. 共有（全団共有備品用）

**データモデル：**
```python
class Group(Base):
    id: Integer (Primary Key)
    name: String (団名)
    description: String (説明)
```

**エンドポイント：**
- `GET /api/groups` - 団体一覧取得
- `POST /api/groups` - 団体登録

---

### 4. 備品管理機能の拡張

**追加機能：**
- CSV一括アップロード
- 所有団によるフィルタリング
- 承認指導者・担当スカウトの関連付け（外部キー）

**更新されたデータモデル：**
```python
class Item(Base):
    id: Integer (Primary Key)
    name: String (備品名)
    category: String (カテゴリ)
    status: String (ステータス)
    location: String (保管場所)
    owner_group_id: Integer (所有団 Foreign Key)
    approved_leader_id: Integer (承認指導者 Foreign Key, Optional)
    responsible_scout_id: Integer (担当スカウト Foreign Key, Optional)
    note: String (備考)
```

**新規エンドポイント：**
- `POST /api/items/upload-csv` - CSV一括登録

**CSVフォーマット：**
```csv
name,category,status,location,owner_group_id,note
テント10人用,テント,保管中,倉庫A,1,良好
```

---

### 5. データベースのクラウド化（Supabase）

**実装内容：**
- SQLiteからSupabase PostgreSQLへ移行
- 環境変数による接続管理（`.env`ファイル）
- Alembicによるマイグレーション管理

**技術スタック：**
- **Supabase**: PostgreSQL as a Service
- **接続方式**: Connection Pooling (Session mode, port 6543)
- **ORM**: SQLAlchemy 2.0.36
- **ドライバ**: psycopg2-binary 2.9.9
- **マイグレーションツール**: Alembic 1.13.0

**環境変数設定：**
```bash
# backend/.env
DATABASE_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-1-ap-northeast-2.pooler.supabase.com:6543/postgres
```

**マイグレーション構成：**
```
backend/
├── alembic/
│   ├── versions/
│   │   └── cd65016c92fc_initial_migration.py
│   ├── env.py
│   └── script.py.mako
├── alembic.ini
└── .env (gitignoreに追加)
```

**マイグレーションコマンド：**
```bash
# 初期化（初回のみ）
poetry run alembic init alembic

# マイグレーションファイル生成（自動検出）
poetry run alembic revision --autogenerate -m "migration message"

# マイグレーション実行
poetry run alembic upgrade head
```

**database.py の更新：**
- 環境変数からDATABASE_URLを読み込み
- SQLiteとPostgreSQLの両方に対応
- dotenvでの環境変数管理

---

### 6. Docker対応

**実装内容：**
- Dockerfile作成（Python 3.11ベース）
- docker-compose.yml作成
- マルチステージビルド未採用（シンプルな構成）

**Dockerfile:**
```dockerfile
FROM python:3.11-slim
WORKDIR /app

# Poetryインストール
RUN curl -sSL https://install.python-poetry.org | python3 - && \
    ln -s /root/.local/bin/poetry /usr/local/bin/poetry

ENV POETRY_VIRTUALENVS_CREATE=false

# 依存関係インストール
COPY pyproject.toml poetry.lock ./
RUN poetry install --no-dev --no-interaction --no-ansi

# アプリケーションコード
COPY . .

EXPOSE 8001
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]
```

**docker-compose.yml:**
```yaml
version: '3.8'
services:
  backend:
    build:
      context: ./backend
    ports:
      - "8001:8001"
    volumes:
      - ./backend:/app
    environment:
      - PYTHONUNBUFFERED=1
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload
```

**使用方法：**
```bash
# ビルドと起動
docker-compose up --build

# バックグラウンド起動
docker-compose up -d

# 停止
docker-compose down
```

---

## データベーススキーマ

### ERD（エンティティ関係図）

```
┌──────────┐       ┌──────────┐
│  groups  │◄─────┐│  leaders │
│          │      ││          │
│ id (PK)  │      │└──────────┘
│ name     │      │
│          │      │
└──────────┘      │
      ▲           │
      │           │
      │           │
┌─────┴────┐      │
│  scouts  │      │
│          │      │
│ id (PK)  │      │
│ group_id ├──────┘
└──────────┘
      ▲
      │
      │
┌─────┴────────────────┐
│       items          │
│                      │
│ id (PK)              │
│ owner_group_id (FK)  │
│ approved_leader_id   │
│ responsible_scout_id │
└──────────────────────┘
```

### テーブル一覧

| テーブル名 | 説明 | レコード数（初期） |
|----------|------|------------------|
| groups | 団体情報 | 9 |
| leaders | 指導者情報 | 4 |
| scouts | スカウト情報 | 5 |
| items | 備品情報 | 10 |

---

## API エンドポイント一覧

### Groups（団体）
- `GET /api/groups` - 一覧取得
- `POST /api/groups` - 登録

### Leaders（指導者）
- `GET /api/leaders` - 一覧取得
- `POST /api/leaders` - 登録
- `PUT /api/leaders/{id}` - 更新

### Scouts（スカウト）
- `GET /api/scouts` - 一覧取得
- `POST /api/scouts` - 登録
- `PUT /api/scouts/{id}` - 更新
- `POST /api/scouts/upload-csv` - CSV一括登録

### Items（備品）
- `GET /api/items` - 一覧取得（検索・フィルタ対応）
- `POST /api/items` - 登録
- `PUT /api/items/{id}` - 更新（実装予定）
- `DELETE /api/items/{id}` - 削除（実装予定）
- `POST /api/items/upload-csv` - CSV一括登録

---

## フロントエンド構成

### ページ一覧

| パス | 説明 | 認証 |
|-----|------|-----|
| `/` | 備品管理（メイン画面） | なし |
| `/scouts` | スカウト管理 | パスワード認証あり |
| `/leaders` | 指導者管理 | なし |

### 使用技術

- **フレームワーク**: Next.js 16.1.6 (App Router)
- **UI**: React 19.2.3, TypeScript
- **スタイリング**: Tailwind CSS 4
- **コンポーネント**: shadcn/ui (table, button, input, label, card, badge, select)
- **状態管理**: React Hooks (useState, useEffect)
- **認証**: sessionStorage（スカウトページ）

### 主要機能

**備品管理画面（`/`）:**
- 検索機能（備品名・カテゴリで絞り込み）
- ステータスフィルタ（保管中/貸出中/要メンテ）
- 所属団フィルタ
- 統計ダッシュボード（総数、ステータス別集計）
- 新規登録フォーム

**スカウト管理画面（`/scouts`）:**
- パスワード認証（セッション管理）
- CSV一括アップロード
- インライン編集（班名）
- 学年別統計
- 団体フィルタ

**指導者管理画面（`/leaders`）:**
- インライン編集（役職）
- 個人情報の非表示（公開画面では表示しない）
- 団体フィルタ

---

## 依存関係の更新

### Backend (pyproject.toml)

```toml
[tool.poetry.dependencies]
python = ">=3.11,<4.0"
fastapi = "^0.115.6"
uvicorn = { version = "^0.34.0", extras = ["standard"] }
sqlalchemy = "^2.0.36"
pydantic = "^2.0.0"
python-multipart = "^0.0.20"      # CSV アップロード
python-dotenv = "^1.0.0"          # 環境変数管理（新規）
psycopg2-binary = "^2.9.9"        # PostgreSQL ドライバ（新規）
alembic = "^1.13.0"               # マイグレーション（新規）
```

### Frontend (package.json)

変更なし（shadcn/uiコンポーネントの追加のみ）

---

## セキュリティ・プライバシー対応

### 1. 個人情報の保護
- 指導者の電話番号、メールアドレス、性別は公開画面に表示しない
- バックエンドにはデータを保持（内部管理用）
- フロントエンドの表示とフォームから除外

### 2. スカウトページの認証
- パスワード: `19nsj@saitama7tai`
- sessionStorageで認証状態を管理
- 認証なしではスカウト情報にアクセス不可

### 3. 環境変数の保護
- `.env`ファイルを`.gitignore`に追加
- データベース接続情報をリポジトリに含めない
- デプロイ時は環境変数で設定

---

## プロジェクト構造（最終版）

```
jumbory-item-manager/
├── backend/
│   ├── alembic/                    # マイグレーション（新規）
│   │   ├── versions/
│   │   │   └── cd65016c92fc_initial_migration.py
│   │   ├── env.py
│   │   └── script.py.mako
│   ├── app/
│   │   ├── database.py            # 更新: PostgreSQL対応
│   │   ├── models.py              # 更新: 4テーブル
│   │   └── schemas.py             # 更新: Update スキーマ追加
│   ├── main.py                    # 更新: CRUD + CSV upload
│   ├── pyproject.toml             # 更新: 依存関係追加
│   ├── poetry.lock                # 更新
│   ├── Dockerfile                 # 新規
│   ├── .dockerignore              # 新規
│   ├── alembic.ini                # 新規
│   ├── .env                       # 新規（gitignore）
│   └── .gitignore                 # 更新
├── frontend/
│   └── src/
│       ├── app/
│       │   ├── page.tsx           # 備品管理
│       │   ├── scouts/
│       │   │   └── page.tsx       # 新規: スカウト管理
│       │   └── leaders/
│       │       └── page.tsx       # 新規: 指導者管理
│       ├── components/ui/         # shadcn/ui コンポーネント
│       └── types/
│           ├── item.ts            # 更新
│           ├── scout.ts           # 新規
│           └── leader.ts          # 新規
├── docs/
│   ├── overview.md
│   ├── data_flow.md
│   ├── implementation_log.md
│   └── updates_2026-02-14.md      # 本ドキュメント
├── docker-compose.yml             # 新規
└── README.md                      # 更新: Docker手順追加
```

---

## 動作確認

### 1. Supabase接続確認

```bash
# 団体データ取得
curl -s http://127.0.0.1:8001/api/groups | jq '.'

# レスポンス例
[
  {
    "name": "春日部第９団",
    "description": "ボーイスカウト春日部第９団",
    "id": 1
  },
  ...
]
```

### 2. CSV アップロード確認

**スカウトCSV例:**
```csv
name,name_kana,group_id,grade,rank,gender,patrol
田中太郎,たなかたろう,1,中2,2級,男,イーグル班
```

**備品CSV例:**
```csv
name,category,status,location,owner_group_id,note
テント10人用,テント,保管中,倉庫A,1,良好
```

### 3. パスワード認証確認

1. `http://localhost:3000/scouts` にアクセス
2. パスワード入力画面が表示される
3. `19nsj@saitama7tai` を入力してログイン
4. スカウト管理画面が表示される

---

## 今後の拡張予定

### 実装予定の機能

1. **Helpページ**
   - 使い方ガイド
   - CSV フォーマット説明
   - FAQ

2. **備品ページのCSV UI**
   - スカウトページと同様のCSVアップロードUI
   - プレビュー機能

3. **削除機能**
   - 備品、スカウト、指導者の削除
   - 確認ダイアログ

4. **検索機能の強化**
   - 全文検索
   - 複数条件の組み合わせ

5. **デプロイ**
   - Vercel (フロントエンド)
   - Railway / Render (バックエンド)
   - Supabase (データベース)

---

## 開発環境

- **OS**: Linux (Ubuntu/Debian系)
- **Python**: 3.11
- **Node.js**: 最新LTS
- **Poetry**: 最新版
- **Docker**: Docker Engine + Docker Compose

---

## Git コミット履歴（本日分）

1. `ee269cb` - Add scouts/leaders management with password authentication
2. `ff6f408` - Add Supabase PostgreSQL integration and Docker support

---

## まとめ

本日の開発で、Jumbory備品管理システムは以下の点で大きく進化しました：

✅ **機能面**: 備品だけでなく、スカウト・指導者も管理可能に  
✅ **データ管理**: CSV一括登録で実用性向上  
✅ **セキュリティ**: パスワード認証、個人情報保護  
✅ **インフラ**: ローカルSQLiteからクラウドPostgreSQLへ  
✅ **運用**: Dockerコンテナ化、マイグレーション管理  

次のステップは、Helpページの作成とデプロイ準備です。
